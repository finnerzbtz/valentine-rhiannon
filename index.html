<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>For You</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0a;color:#d4af37;font-family:'Cormorant Garamond',serif;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}

#pw-screen{position:fixed;inset:0;z-index:100;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s}
#pw-screen.gone{opacity:0;visibility:hidden;pointer-events:none}
#pw-screen .lock{font-size:48px;margin-bottom:30px;opacity:.6}
#pw-screen label{font-family:'Playfair Display',serif;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:#d4af37;opacity:.6;margin-bottom:14px}
#pw-input{background:0 0;border:none;border-bottom:1px solid rgba(212,175,55,.25);color:#d4af37;font-family:'Cormorant Garamond',serif;font-size:18px;padding:12px 20px;width:280px;text-align:center;outline:0;transition:border-color .3s}
#pw-input:focus{border-bottom-color:rgba(212,175,55,.7)}
#pw-input::placeholder{color:rgba(212,175,55,.15)}
#pw-err{color:#ff6b6b;font-size:13px;margin-top:12px;opacity:0;transition:opacity .3s}
#pw-err.show{opacity:1}

canvas#ptcl{position:fixed;inset:0;z-index:0;pointer-events:none}
canvas#fluid{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.18}

#book{position:fixed;inset:0;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity 1s}
#book.vis{opacity:1}

.slide{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;opacity:0;transition:opacity .5s ease,transform .5s ease;transform:scale(.96);pointer-events:none}
.slide.active{opacity:1;transform:scale(1);pointer-events:auto}

#cover h1{font-family:'Playfair Display',serif;font-size:28px;font-weight:400;color:#d4af37;text-align:center;line-height:1.5;margin-bottom:6px}
#cover .sub{font-size:20px;font-style:italic;color:rgba(212,175,55,.45);margin-bottom:50px}
#cover .hint{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(212,175,55,.25);position:absolute;bottom:55px;animation:pulse 2.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.2}50%{opacity:.6}}

.photo-frame{position:relative;max-width:88vw;max-height:72vh;border-radius:4px;overflow:hidden;box-shadow:0 0 30px rgba(212,175,55,.06),0 0 60px rgba(212,175,55,.03)}
.photo-frame img,.photo-frame video{display:block;max-width:88vw;max-height:72vh;object-fit:contain;border-radius:4px}
.photo-frame::after{content:'';position:absolute;inset:0;border:1px solid rgba(212,175,55,.12);border-radius:4px;pointer-events:none}
.photo-glow{position:absolute;inset:-50px;background:radial-gradient(ellipse at center,rgba(212,175,55,.05) 0%,transparent 70%);pointer-events:none;z-index:-1}

#dots{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:10}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(212,175,55,.15);transition:background .3s,transform .3s}
.dot.active{background:rgba(212,175,55,.7);transform:scale(1.4)}

#final h2{font-family:'Playfair Display',serif;font-size:22px;font-weight:400;color:#d4af37}
#final .msg{font-size:19px;font-style:italic;color:#d4af37;line-height:1.8;max-width:300px;opacity:.85;text-align:center;margin-top:20px}
#final .heart{font-size:40px;margin-bottom:24px;opacity:.5}
#final .sign{font-size:15px;color:rgba(212,175,55,.4);margin-top:28px}

#music-btn{position:fixed;top:14px;right:14px;z-index:50;width:34px;height:34px;border-radius:50%;background:rgba(212,175,55,.08);border:1px solid rgba(212,175,55,.15);color:#d4af37;font-size:15px;display:none;align-items:center;justify-content:center;cursor:pointer}
#music-btn.vis{display:flex}
#music-btn.playing{animation:spin 3s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

.page-num{position:absolute;bottom:28px;font-size:11px;letter-spacing:1px;color:rgba(212,175,55,.2)}
#start-overlay{position:fixed;inset:0;z-index:90;background:rgba(10,10,10,.95);display:none;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
#start-overlay.show{display:flex}
#start-overlay .play-icon{width:80px;height:80px;border:2px solid rgba(212,175,55,.4);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:24px;transition:transform .2s,border-color .2s}
#start-overlay .play-icon::after{content:'';width:0;height:0;border-style:solid;border-width:16px 0 16px 28px;border-color:transparent transparent transparent rgba(212,175,55,.6);margin-left:6px}
#start-overlay:active .play-icon{transform:scale(.9);border-color:rgba(212,175,55,.8)}
#start-overlay .start-text{font-family:'Playfair Display',serif;font-size:14px;letter-spacing:3px;text-transform:uppercase;color:rgba(212,175,55,.5)}

#progress-bar{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,#d4af37,#f5d77a);z-index:60;width:0;transition:width .3s linear;pointer-events:none}
body.holding::after{content:'‚ùö‚ùö';position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;color:rgba(212,175,55,.35);z-index:55;pointer-events:none;animation:holdFade .3s ease}
body.holding #book{filter:brightness(.85);transition:filter .2s ease}
@keyframes holdFade{from{opacity:0;transform:translate(-50%,-50%) scale(.8)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
</style>
</head>
<body>

<div id="pw-screen">
  <div class="lock">üîí</div>
  <label>enter password</label>
  <input type="text" id="pw-input" placeholder="..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <div id="pw-err">try again ‚ù§Ô∏è</div>
</div>

<canvas id="fluid"></canvas>
<canvas id="ptcl"></canvas>

<div id="start-overlay">
  <div class="play-icon"></div>
  <div class="start-text">tap to begin</div>
</div>
<div id="book">
  <div class="slide active" id="cover">
    <h1>Happy<br>Valentine's Day</h1>
    <div class="sub">Rhiannon</div>
    <div class="hint">swipe to begin</div>
  </div>

  <div class="slide" data-idx="1">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/01_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="2">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/02_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="3">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/03_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="4">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/04_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="5">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/05_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="6">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/06.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="7">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/07_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="8">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/08_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="9">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/09_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="10">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/10_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="11">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/11_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="12">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/12_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="13">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/13_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="14">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/14_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="15">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/15_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="16">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/16_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="17">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/17_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="18">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/18_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="19">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/19_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="20">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/20_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="21">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/21_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="22">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/22_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="23">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/23_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="24">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/24_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="25">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/25_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="26">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/26_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="27">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/27_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="28">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/28.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="29">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/29.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="30">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/30.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="31">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/31_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="32">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/32_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="33">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/33_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="34">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/34_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="35">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/35_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="36">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/36_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="37">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/37_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="38">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/38_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="39">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/39_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="40">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/40_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="41">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/41_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="42">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/42_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="43">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/43_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="44">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/44_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="45">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/45_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="46">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/46_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="47">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/47_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="48">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/48.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="49">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/49.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="50">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/50.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" data-idx="51">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/51_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="52">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/52_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="53">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/53_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="54">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/54_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="55">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/55_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="56">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/56_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="57">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/57_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="58">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/58_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="59">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/59_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="60">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/60_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="61">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/61_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="62">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/62_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="63">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/63_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="64">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/64_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="65">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <img data-src="photos/65_web.jpg" alt="" class="lazy">
    </div>
  </div>

  <div class="slide" data-idx="66">
    <div class="photo-glow"></div>
    <div class="photo-frame">
      <video data-src="photos/66.mp4" playsinline muted loop class="lazy-vid"></video>
    </div>
  </div>

  <div class="slide" id="final">
    <div class="heart">‚ù§Ô∏è</div>
    <div class="msg">you and me
always and forever</div>
    <div class="sign">forever yours x</div>
  </div>
</div>

<div id="progress-bar"></div>
<div id="dots"></div>
<div id="music-btn">‚ô´</div>
<audio id="bgm" preload="auto" loop src="music.mp3"></audio>

<script>
const PW='babeiloveyousomuchwhatdaheck';
const pwS=document.getElementById('pw-screen'),pwI=document.getElementById('pw-input'),pwE=document.getElementById('pw-err'),book=document.getElementById('book');
const mbtn=document.getElementById('music-btn'),bgm=document.getElementById('bgm');

pwI.addEventListener('input',()=>{pwE.classList.remove('show');if(pwI.value.toLowerCase().trim()===PW)unlock()});
pwI.addEventListener('keydown',e=>{if(e.key==='Enter'){if(pwI.value.toLowerCase().trim()===PW)unlock();else{pwE.classList.add('show');pwI.style.borderBottomColor='#ff6b6b';setTimeout(()=>pwI.style.borderBottomColor='',800)}}});

function unlock(){
  pwS.classList.add('gone');initPtcl();initFluid();loadAround(0);
  setTimeout(()=>pwS.style.display='none',800);
  // Show tap-to-start overlay (iOS needs a real tap for audio)
  document.getElementById('start-overlay').classList.add('show');
}
document.getElementById('start-overlay').addEventListener('click',function(){
  this.classList.remove('show');
  book.classList.add('vis');
  mbtn.classList.add('vis');
  loadAll();
  bgm.play().then(()=>{
    playing=true;mbtn.classList.add('playing');mbtn.textContent='‚è∏';
    startAutoAdvance();requestAnimationFrame(updateProgress);
  }).catch(()=>{});
});

const slides=document.querySelectorAll('.slide');
const N=slides.length;
let cur=0;

// Dots
const dotsC=document.getElementById('dots');
for(let i=0;i<N;i++){const d=document.createElement('div');d.className='dot'+(i===0?' active':'');dotsC.appendChild(d)}
const dots=document.querySelectorAll('.dot');

function goTo(i){
  if(i<0||i>=N||i===cur)return;
  const prev=cur;
  cur=i;
  slides[prev].classList.remove('active');
  slides[cur].classList.add('active');
  dots[prev].classList.remove('active');
  dots[cur].classList.add('active');
  loadAround(cur);
  // Video control: pause old, play new
  const oldV=slides[prev].querySelector('video');
  if(oldV)oldV.pause();
  const newV=slides[cur].querySelector('video');
  if(newV)newV.play().catch(()=>{});
}

// Lazy loading
function loadAround(idx){
  for(let d=-1;d<=2;d++){
    const j=idx+d;if(j<0||j>=N)continue;
    const s=slides[j];
    s.querySelectorAll('img.lazy').forEach(img=>{if(!img.src&&img.dataset.src)img.src=img.dataset.src;img.classList.remove('lazy')});
    s.querySelectorAll('video.lazy-vid').forEach(vid=>{if(!vid.src&&vid.dataset.src)vid.src=vid.dataset.src;vid.classList.remove('lazy-vid')});
  }
}
function loadAll(){
  slides.forEach(s=>{
    s.querySelectorAll('img.lazy').forEach(img=>{if(!img.src&&img.dataset.src)img.src=img.dataset.src;img.classList.remove('lazy')});
    s.querySelectorAll('video.lazy-vid').forEach(vid=>{if(!vid.src&&vid.dataset.src)vid.src=vid.dataset.src;vid.classList.remove('lazy-vid')});
  });
}

// === Auto-advance synced to music ===
const BAR_MS = 2308; // 104 BPM, 1 bar = 60/104*4 = 2.308s
const BAR_MS_VIDEO = BAR_MS * 2; // Videos get 2 bars
let autoTimer = null;
let holding = false;
let swiped = false;
const progressBar = document.getElementById('progress-bar');

function isVideoSlide(idx) {
  return !!slides[idx] && !!slides[idx].querySelector('video');
}

function startAutoAdvance() {
  stopAutoAdvance();
  if (!playing) return;
  const delay = isVideoSlide(cur) ? BAR_MS_VIDEO : BAR_MS;
  autoTimer = setTimeout(function tick() {
    if (!playing) return;
    if (!holding) {
      if (cur < N - 1) {
        goTo(cur + 1);
        const nextDelay = isVideoSlide(cur) ? BAR_MS_VIDEO : BAR_MS;
        autoTimer = setTimeout(tick, nextDelay);
      }
      // At last slide, stop (don't loop ‚Äî loop handled by audio event)
    } else {
      // Still holding, check again soon
      autoTimer = setTimeout(tick, 100);
    }
  }, delay);
}

function stopAutoAdvance() {
  if (autoTimer) { clearTimeout(autoTimer); autoTimer = null; }
}

// Update progress bar from audio
function updateProgress() {
  if (bgm.duration && bgm.duration > 0) {
    const pct = (bgm.currentTime / bgm.duration) * 100;
    progressBar.style.width = pct + '%';
  }
  if (playing) requestAnimationFrame(updateProgress);
}

// Music loop: restart slideshow from beginning
// Removed 'loop' attribute from <audio> so 'ended' fires reliably.
// We manually restart playback + slideshow here.
bgm.addEventListener('ended', () => {
  if (playing) {
    bgm.currentTime = 0;
    bgm.play().catch(()=>{});
    goTo(0);
    startAutoAdvance();
  }
});

// Swipe + Hold-to-pause
let tx=0,ty=0,sw=false,lastSwipeTime=0;
document.addEventListener('touchstart',e=>{
  tx=e.touches[0].clientX;ty=e.touches[0].clientY;sw=true;
  // Hold-to-pause (only if book is visible)
  if (pwS.classList.contains('gone')) {
    holding = true;
    document.body.classList.add('holding');
  }
},{passive:true});

document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
  swiped = Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>40;
  if(swiped&&sw){
    dx<0?goTo(cur+1):goTo(cur-1);
    lastSwipeTime = Date.now();
    // After manual swipe, restart auto-advance from new position
    if (playing) startAutoAdvance();
  }
  sw=false;
  // Release hold
  holding = false;
  document.body.classList.remove('holding');
},{passive:true});

document.addEventListener('touchcancel',()=>{
  holding = false;
  sw = false;
  document.body.classList.remove('holding');
},{passive:true});

// Tap edges (skip if just swiped to avoid double-advance)
document.addEventListener('click',e=>{
  if(pwS.style.display!=='none'&&!pwS.classList.contains('gone'))return;
  if(e.target.id==='music-btn'||e.target.closest('#music-btn'))return; // don't navigate on music btn
  if(Date.now() - lastSwipeTime < 400) return; // ignore click after swipe
  const x=e.clientX/window.innerWidth;
  if(x>.7){goTo(cur+1);if(playing)startAutoAdvance()}
  else if(x<.3){goTo(cur-1);if(playing)startAutoAdvance()}
});

// Keys
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight'){goTo(cur+1);if(playing)startAutoAdvance()}
  if(e.key==='ArrowLeft'){goTo(cur-1);if(playing)startAutoAdvance()}
});

// Particles
function initPtcl(){
  const c=document.getElementById('ptcl'),ctx=c.getContext('2d');let W,H,pts=[];
  function sz(){W=c.width=innerWidth;H=c.height=innerHeight}sz();
  addEventListener('resize',sz);
  for(let i=0;i<45;i++)pts.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.8+.4,vx:(Math.random()-.5)*.25,vy:(Math.random()-.5)*.25,a:Math.random()*.25+.04});
  function draw(){ctx.clearRect(0,0,W,H);for(const p of pts){p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=`rgba(212,175,55,${p.a})`;ctx.fill()}requestAnimationFrame(draw)}draw()
}

// Music

let playing=false;

function startMusic() {
  bgm.play().then(()=>{
    playing=true;
    mbtn.classList.add('playing');mbtn.textContent='‚è∏';
    startAutoAdvance();
    requestAnimationFrame(updateProgress);
  }).catch(()=>{});
}

function pauseMusic() {
  bgm.pause();
  playing=false;
  mbtn.classList.remove('playing');mbtn.textContent='‚ô´';
  stopAutoAdvance();
}

function tryMusic(){
  mbtn.classList.add('vis');
}
mbtn.addEventListener('click',()=>{
  if(playing) pauseMusic();
  else startMusic();
});
// FLUID DYNAMICS
function initFluid(){
  const c=document.getElementById('fluid'),gl=c.getContext('webgl');
  if(!gl){return}
  function sz(){c.width=innerWidth;c.height=innerHeight;gl.viewport(0,0,c.width,c.height)}
  sz();addEventListener('resize',sz);

  const vs=`attribute vec2 p;void main(){gl_Position=vec4(p,0,1);}`;
  const fs=`
precision mediump float;
uniform float t;
uniform vec2 r;

vec3 palette(float x){
  vec3 pink=vec3(.92,.25,.45);
  vec3 red=vec3(.85,.12,.15);
  vec3 orange=vec3(.95,.45,.12);
  vec3 deep=vec3(.35,.02,.08);
  float s=x*3.0;
  if(s<1.0)return mix(deep,red,s);
  if(s<2.0)return mix(red,pink,s-1.0);
  return mix(pink,orange,s-2.0);
}

float noise(vec2 p){
  return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453);
}

float smooth_noise(vec2 p){
  vec2 i=floor(p),f=fract(p);
  f=f*f*(3.0-2.0*f);
  float a=noise(i),b=noise(i+vec2(1,0)),c=noise(i+vec2(0,1)),d=noise(i+vec2(1,1));
  return mix(mix(a,b,f.x),mix(c,d,f.x),f.y);
}

float fbm(vec2 p){
  float v=0.0,a=0.5;
  for(int i=0;i<5;i++){v+=a*smooth_noise(p);p*=2.1;a*=0.5;}
  return v;
}

void main(){
  vec2 uv=gl_FragCoord.xy/r;
  float s=t*0.15;
  
  vec2 q=vec2(fbm(uv*2.5+vec2(s,s*0.7)),fbm(uv*2.5+vec2(s*1.3,s*0.4)));
  vec2 w=vec2(fbm(uv*3.0+q*1.5+vec2(s*0.5,s*0.8)),fbm(uv*3.0+q*1.5+vec2(s*0.7,s*0.3)));
  
  float f=fbm(uv*2.0+w*2.0);
  f=f*f*1.8;
  
  vec3 col=palette(f);
  
  // Vignette
  float vig=1.0-length((uv-0.5)*1.4);
  vig=smoothstep(0.0,0.7,vig);
  col*=vig;
  
  gl_FragColor=vec4(col,1.0);
}`;

  function mkS(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);return s}
  const prg=gl.createProgram();
  gl.attachShader(prg,mkS(gl.VERTEX_SHADER,vs));
  gl.attachShader(prg,mkS(gl.FRAGMENT_SHADER,fs));
  gl.linkProgram(prg);gl.useProgram(prg);

  const buf=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,buf);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);
  const p=gl.getAttribLocation(prg,'p');
  gl.enableVertexAttribArray(p);
  gl.vertexAttribPointer(p,2,gl.FLOAT,false,0,0);

  const uT=gl.getUniformLocation(prg,'t');
  const uR=gl.getUniformLocation(prg,'r');
  let start=Date.now();

  function draw(){
    gl.uniform1f(uT,(Date.now()-start)/1000);
    gl.uniform2f(uR,c.width,c.height);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
    requestAnimationFrame(draw);
  }
  draw();
}
</script>
</body>
</html>